<!doctype html>
<html lang="es" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CuidaDigital | Administrativo</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="48x48">
    <link id="favicon" rel="icon" href="https://strapi-static-files-prod.s3.amazonaws.com/favicon_7b4f57ba1f.png">
    <link rel="favicon" type="image/png" href="https://strapi-static-files-prod.s3.amazonaws.com/favicon_7b4f57ba1f.png">
    <link id="favicon" rel="shortcut icon" href="https://strapi-static-files-prod.s3.amazonaws.com/favicon_7b4f57ba1f.png">
    <meta name="theme-color" content="#3a57e8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- CSS -->
    <link rel="stylesheet" href="../../assets/css/core/libs.min.css" />
    <link rel="stylesheet" href="../../assets/css/hope-ui.min.css?v=4.0.0" />
    <link rel="stylesheet" href="../../assets/css/custom.min.css?v=4.0.0" />
    <link rel="stylesheet" href="../../assets/css/dark.min.css" />
    <link rel="stylesheet" href="../../assets/css/customizer.min.css" />
    <link rel="stylesheet" href="../../assets/css/rtl.min.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"
    />
  </head>

  <body>
    <!-- loader Start -->
    <div id="loading">
      <div class="loader simple-loader">
        <div class="loader-body"></div>
      </div>
    </div>
    <!-- loader END -->

    <div class="wrapper">
      <section class="login-content">
        <div class="row m-0 align-items-center bg-white vh-100">
          <div class="col-md-6">
            <div class="row justify-content-center">
              <div class="col-md-10">
                <div
                  class="card card-transparent shadow-none d-flex justify-content-center mb-0 auth-card"
                >
                  <div class="card-body">
                    <div class="logo-main">
                      <div class="logo-normal">
                        <!-- Logo SVG omitido para brevedad -->
                      </div>
                    </div>
                    <div>
                      <svg width="200" height="28" class="Navbar_navbar__left_logo__icon__vXe2w" viewBox="0 0 200 28" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M85.1697 1.07156C84.3051 1.08509 83.6178 1.79815 83.6272 2.6668V9.51591L82.9101 9.00852C81.4989 8.01403 79.8184 7.48093 78.0987 7.47687C73.3576 7.47687 69.5015 11.4521 69.5015 16.338C69.5015 21.2238 73.3576 25.199 78.0987 25.199C79.8766 25.2031 81.6112 24.6348 83.0454 23.5794L83.5203 23.3129L83.7355 23.9421C83.9411 24.5739 84.527 25.0042 85.1873 25.011C86.0532 24.9974 86.7433 24.2844 86.7325 23.4157V2.67763C86.7501 1.80897 86.0587 1.08915 85.1941 1.07156H85.1697ZM81.1728 21.079C79.0079 22.5904 76.0746 22.3157 74.2195 20.4363C73.1114 19.3512 72.4863 17.8642 72.489 16.3082C72.489 13.2043 74.9975 10.6863 78.0892 10.6863C81.1809 10.6863 83.6895 13.2043 83.6895 16.3082C83.6962 18.2187 82.7599 20.0033 81.1877 21.079H81.1742H81.1728Z" fill="#573CD6"></path>
                        <path d="M63.065 3.15794C63.1056 2.11609 63.981 1.30562 65.0175 1.34892C66.0214 1.37598 66.8184 2.20133 66.8184 3.208C66.8211 3.231 66.8197 3.25265 66.8184 3.27565C66.8184 3.28647 66.8184 3.29865 66.8184 3.30948C66.7778 4.35132 65.9024 5.16179 64.8659 5.1185C63.8281 5.0779 63.0204 4.19843 63.0637 3.15794H63.065Z" fill="#573CD6"></path>
                        <path d="M56.7519 8.96254C56.7424 8.11688 57.4122 7.42412 58.2538 7.41059C59.1021 7.41465 59.7895 8.10065 59.799 8.94901V17.7871C59.799 21.8746 56.5733 25.2018 52.6021 25.2018C48.631 25.2018 45.4026 21.8746 45.4026 17.7871V8.94901C45.4053 8.09388 46.0967 7.40112 46.9478 7.39706C47.7894 7.41059 48.4632 8.10335 48.4523 8.94901V17.7993C48.4523 20.0981 50.3114 21.9639 52.6008 21.9639C54.8901 21.9639 56.7492 20.0981 56.7492 17.7993V8.96254H56.7519Z" fill="#573CD6"></path>
                        <path d="M40.2678 11.8094C39.3112 11.0449 38.1232 10.6254 36.9001 10.6295L36.9068 10.6471C33.8733 10.7174 31.4311 13.1732 31.3567 16.2189C31.2795 19.3729 33.7637 21.9937 36.9068 22.0708C38.1286 22.0668 39.318 21.6514 40.2746 20.8869C40.5912 20.6339 40.9984 20.5216 41.3989 20.5798C41.7994 20.6339 42.1634 20.8463 42.4097 21.1711C42.6559 21.5161 42.7628 21.9423 42.7127 22.3644C42.6627 22.7704 42.4503 23.1357 42.1228 23.3792C40.6372 24.5699 38.793 25.2153 36.8892 25.2045C32.1482 25.2045 28.2893 21.2292 28.2893 16.3434C28.2893 11.4576 32.1482 7.48503 36.8892 7.48503C38.7916 7.4742 40.6412 8.12096 42.1296 9.31434C42.4665 9.58089 42.6816 9.97057 42.7317 10.3968C42.7818 10.7919 42.6708 11.1883 42.4286 11.5022C42.1756 11.8432 41.7954 12.0664 41.3786 12.1206C40.9809 12.172 40.5804 12.0597 40.2678 11.8094Z" fill="#573CD6"></path>
                        <path d="M65.015 7.41061C64.149 7.42414 63.459 8.1372 63.4698 9.00585V23.2899C63.4292 24.1451 64.0895 24.8716 64.9419 24.9122C65.793 24.9528 66.5182 24.2898 66.5588 23.4347C66.5615 23.3874 66.5615 23.3373 66.5588 23.2899V8.99367C66.5615 8.13179 65.8755 7.4282 65.0163 7.41197L65.015 7.41061Z" fill="#573CD6"></path>
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M103.667 9.3373C103.728 8.53224 104.391 7.90714 105.196 7.90037H105.21C106.074 7.91119 106.766 8.62425 106.755 9.4929V23.4157C106.766 24.2844 106.078 24.9974 105.212 25.011C104.549 25.0042 103.962 24.5753 103.758 23.9421L103.543 23.3129L103.068 23.5794C101.634 24.6348 99.903 25.199 98.1251 25.199C93.384 25.199 89.5251 21.2238 89.5251 16.338C89.5251 11.4521 93.384 7.47687 98.1251 7.47687C99.8529 7.47687 101.536 8.01132 102.95 9.00851L103.667 9.51184V9.33595V9.3373ZM101.903 20.4877L101.984 20.4106V20.4214C103.083 19.339 103.701 17.8547 103.698 16.3109C103.701 16.2202 103.701 16.1282 103.698 16.0376C103.624 12.931 101.054 10.4766 97.96 10.551C94.8656 10.6254 92.4166 13.2043 92.4951 16.3122C92.4951 18.2052 93.4246 19.9736 94.9779 21.0452C97.0954 22.5498 99.9788 22.3401 101.854 20.5378L101.905 20.4904L101.903 20.4877Z" fill="#573CD6"></path>
                        <path d="M11.2815 27.3572H11.1935C6.53364 27.3342 2.2932 24.6524 0.262285 20.4404C-0.370939 19.1185 0.181103 17.53 1.50167 16.8941C2.81818 16.2582 4.40124 16.8129 5.03447 18.1348C6.17644 20.5121 8.56726 22.0262 11.1935 22.0424H11.2815C13.901 22.0248 16.2891 20.5175 17.4338 18.1511C18.0697 16.8291 19.6568 16.2784 20.9733 16.9171C22.2898 17.5557 22.8392 19.1483 22.2019 20.4702C20.1615 24.666 15.9278 27.3369 11.2815 27.3572Z" fill="#573CD6"></path>
                        <path d="M8.07886 12.0122C6.88007 13.9092 7.43887 16.4245 9.32772 17.6314C11.2166 18.8356 13.7251 18.2741 14.9239 16.3772L17.9317 11.6577L11.0853 7.26846L8.07886 12.0122Z" fill="#FF795C"></path>
                        <path d="M19.6813 1.28264C17.8033 0.0757207 15.3042 0.626409 14.0986 2.51255C14.0946 2.51932 14.0892 2.52879 14.0851 2.53555L11.0854 7.2685L17.9318 11.6578L20.9315 6.90047C22.1303 5.0035 21.5715 2.4882 19.6827 1.28128L19.6813 1.28264Z" fill="#573CD6"></path>
                      </svg>
                    </div>
                    <h2 class="mb-2 text-center">Iniciar Sesión</h2>
                    <p class="text-center">Administrador de soportes</p>
                    <form>
                      <div class="row">
                        <div class="col-lg-12">
                          <div class="form-group">
                            <label for="email" class="form-label">Correo</label>
                            <input
                              type="email"
                              class="form-control"
                              id="email"
                              placeholder=""
                            />
                            <div class="invalid-feedback">
                              Ingresa un correo válido.
                            </div>
                          </div>
                        </div>
                        <div class="col-lg-12">
                          <div class="form-group">
                            <label for="password" class="form-label"
                              >Contraseña</label
                            >
                            <input
                              type="password"
                              class="form-control"
                              id="password"
                              placeholder=""
                            />
                            <div class="invalid-feedback">
                              Ingresa una contraseña.
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="d-flex justify-content-center">
                        <button
                          type="submit"
                          id="iniciarSesion"
                          class="btn btn-primary"
                        >
                          Vamos
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div
            class="col-md-6 d-md-block d-none bg-primary p-0 vh-100 overflow-hidden"
          >
            <img
              src="../../assets/images/auth/01.png"
              class="img-fluid gradient-main animated-scaleX"
              alt="images"
            />
          </div>
        </div>
      </section>
    </div>

    <!-- JS -->
    <script>
      // Detecta modo guardado y lo aplica al <body> o al .loader directamente
      (function() {
        const loader = document.querySelector('.loader');
        const color = sessionStorage.getItem("color-mode");
        if (color === "dark" || color === "light") {
          loader.classList.add(color);
        }
      })();
    </script>
    <script src="../../assets/js/core/libs.min.js"></script>
    <script src="../../assets/js/core/external.min.js"></script>
    <script src="../../assets/js/plugins/fslightbox.js"></script>
    <script src="../../assets/js/plugins/setting.js"></script>
    <script src="../../assets/js/plugins/form-wizard.js"></script>
    <script src="../../assets/js/hope-ui.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <script src="./config/index.js"></script>
    
    <script src="./assets/js/aws-amplify.min.js"></script>
    
    <script type="module">
      const { Auth } = window.aws_amplify;

      Auth.configure({
        region: 'us-east-1',
        userPoolId: 'us-east-1_byqG3MxAR',
        userPoolWebClientId: '5nht571b9u5up55tki3p8oaisn'
      });

      // Validar email
      function esCorreoValido(correo) {
        const regexEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return regexEmail.test(correo);
      }

      // Config Toastr
      toastr.options = {
        closeButton: true,
        positionClass: "toast-top-right",
        timeOut: "3000",
      };

      // Detectar cambios para limpiar errores visuales
      document.getElementById("email").addEventListener("input", () => {
        document.getElementById("email").classList.remove("is-invalid");
      });
      document.getElementById("password").addEventListener("input", () => {
        document.getElementById("password").classList.remove("is-invalid");
      });

      // Manejo del login
      document
        .getElementById("iniciarSesion")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          let email = document.getElementById("email");
          let password = document.getElementById("password");

          if (esCorreoValido(email.value) && password.value) {
            try {
              document.getElementById("iniciarSesion").innerHTML = `
              <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>
              Verificando inicio...`;
              document.getElementById("iniciarSesion").disabled = true;
              const user = await loginCognito({ email: email.value.trim(), password: password.value.trim() });
              let arreglo = ["PRINCIPAL"];
              if(user.attributes['website']) {
                arreglo = user.attributes['website'].match(/"([^"]+)"/g).map(s => s.replace(/"/g, ''));
              }
              await localStorage.setItem('detalle', JSON.stringify({secciones: arreglo}));
              await loginUsuario({ email, attributes: user.attributes });
              return
            } catch (error) {
              console.log(error)
              localStorage.clear();
              toastr["error"]("Ingresa correo y contraseña!");
              document.getElementById("iniciarSesion").innerHTML = `
              Vamos`;
              document.getElementById("iniciarSesion").disabled = false;
              email.classList.add("is-invalid");
              password.classList.add("is-invalid");
            }
          } else {
            if (!esCorreoValido(email.value) && !password.value) {
              localStorage.clear();
              toastr["error"]("Ingresa correo y contraseña!");
              email.classList.add("is-invalid");
              password.classList.add("is-invalid");
            } else if (!esCorreoValido(email.value)) {
              localStorage.clear();
              toastr["error"]("Ingresa correo válido!");
              email.classList.add("is-invalid");
            } else if (!password.value) {
              localStorage.clear();
              toastr["error"]("Ingresa la contraseña!");
              password.classList.add("is-invalid");
            }
          }
        });

      async function loginUsuario({ email, attributes }) {
        email.classList.remove("is-invalid");
        password.classList.remove("is-invalid");

        try {
          const response = await fetch(`${API_BASE_URL}public/login.php`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              usuario: email.value,
              attributes
            }),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || "Error en el login");
          }

          toastr["success"]("Login exitoso!");

          // Guardar token
          localStorage.setItem("token", data.token);

          guardarEnLocalStorage(
            "user",
            JSON.stringify({ email: email.value, attributes }),
            data.token,
          );

          // Redirigir, si aplica
          window.location.href = "dashboard/admin.html";
        } catch (error) {
          localStorage.clear();
          toastr["error"]("Usuario inválido!");
          email.classList.add("is-invalid");
          password.classList.add("is-invalid");
          password.value = "";
        }
      }

      // Leer sesión guardada
      function leerSesionGuardada() {
        const token = localStorage.getItem("token");
        if (!token) return;

        const detalle = leerDesdeLocalStorage("user", token);
        if (detalle) {
          const { email, password } = JSON.parse(detalle);
          document.getElementById("email").value = email;
          console.log("🧠 Sesión recordada:", email);
        }
      }

      leerSesionGuardada();

    async function loginCognito({ email, password }) {
      try {
        const user = await Auth.signIn(email, password);

        return user;
      } catch (err) {
        throw err;
      }
    }


    </script>
  
  </body>
</html>
